<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gondwana Collection Namibia - Luxury Lodges & Activities</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <img src="../images/gondwanalogo.webp" alt="Gondwana Collection" class="navbar-logo">
        <div class="mobile-menu-btn" id="mobileMenuBtn">
            <i class="fas fa-bars"></i>
        </div>
        <div class="navbar-links" id="navbarLinks">
            <a href="#">Explore</a>
            <a href="#">Travel Offers</a>
            <a href="#">News & Blog</a>
            <a href="#">About Us</a>
            <a href="#">Contact</a>
            <a href="#" class="book-now-btn">Book Now</a>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h1>Your Journey Begins Here</h1>
            <p>Discover Namibia's most beautiful destinations with Gondwana Collection</p>
        </div>
    </section>

    <!-- Search Form -->
    <form id="searchForm" onsubmit="searchProperties(event)">
        <div class="search-container">
            <div class="search-grid">
                <div class="form-group">
                    <label for="unit">Property</label>
                    <div class="select-wrapper">
                        <select id="unit" name="unit">
                            <option value="" disabled selected>Select a property</option>
                            <option value="Okapuka Safari Lodge">Okapuka Safari Lodge</option>
                            <option value="The Weinberg">The Weinberg</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label for="arrival">Check In</label>
                    <input type="date" id="arrival" name="arrival" required>
                </div>
                <div class="form-group">
                    <label for="departure">Check Out</label>
                    <input type="date" id="departure" name="departure" required>
                </div>
                <div class="form-group">
                    <label for="occupants">Guests</label>
                    <input type="number" id="occupants" name="occupants" required placeholder="Number of guests" min="1">
                </div>
                <div class="form-group">
                    <label for="ages">Ages</label>
                    <input type="text" id="ages" name="ages" required placeholder="e.g. 35,32,12,8">
                </div>
            </div>
            <div class="search-buttons">
                <button type="button" class="search-button" data-search-type="available">
                    <span class="button-text">Search Available Properties</span>
                    <div class="spinner"></div>
                </button>
                <button type="button" class="search-button search-button-secondary" data-search-type="all">
                    <span class="button-text">Search All Properties</span>
                    <div class="spinner"></div>
                </button>
            </div>
        </div>
    </form>

    <!-- Properties Grid -->
    <div id="properties" class="properties-grid"></div>

    <!-- Booking Form Modal -->
    <div id="bookingForm" class="booking-form hidden">
        <div class="booking-form-content">
            <div class="search-container">
                <div class="search-grid">
                    <input type="hidden" id="selectedProperty">
                    <div class="form-group">
                        <label for="booking-arrival">Check In</label>
                        <input type="date" id="booking-arrival" name="arrival" required>
                    </div>
                    <div class="form-group">
                        <label for="booking-departure">Check Out</label>
                        <input type="date" id="booking-departure" name="departure" required>
                    </div>
                    <div class="form-group">
                        <label for="booking-occupants">Guests</label>
                        <input type="number" id="booking-occupants" name="occupants" required placeholder="Number of guests" min="1">
                    </div>
                    <div class="form-group">
                        <label for="booking-ages">Ages</label>
                        <input type="text" id="booking-ages" name="ages" required placeholder="e.g. 35,32,12,8">
                    </div>
                </div>
                <div class="booking-actions">
                    <button type="button" onclick="submitBooking(event)">Confirm Booking</button>
                    <button type="button" onclick="closeBookingForm()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-section">
                <h3>About Gondwana</h3>
                <p>Experience the beauty of Namibia with Gondwana Collection's luxury lodges and activities. We offer unforgettable adventures in some of Africa's most stunning locations.</p>
            </div>
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul class="footer-links">
                    <li><a href="#">Our Lodges</a></li>
                    <li><a href="#">Activities</a></li>
                    <li><a href="#">Special Offers</a></li>
                    <li><a href="#">Gift Vouchers</a></li>
                    <li><a href="#">Photo Gallery</a></li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Contact Us</h3>
                <ul class="footer-links">
                    <li><a href="tel:+264612427375">+264 61 242 7375</a></li>
                    <li><a href="mailto:info@gondwana-collection.com">info@gondwana-collection.com</a></li>
                    <li>P.O. Box 80205</li>
                    <li>Windhoek, Namibia</li>
                </ul>
            </div>
            <div class="footer-section">
                <h3>Follow Us</h3>
                <p>Stay updated with our latest news and special offers.</p>
                <div class="social-links">
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-youtube"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2024 Gondwana Collection Namibia. All rights reserved.</p>
        </div>
    </footer>

    <style>
    .search-buttons {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 1rem;
    }

    .search-button {
        background-color: #2c5282;
        color: white;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 0.375rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        min-width: 200px;
    }

    .search-button:hover {
        background-color: #2a4365;
    }

    .search-button-secondary {
        background-color: #4a5568;
    }

    .search-button-secondary:hover {
        background-color: #2d3748;
    }

    .search-button.loading {
        color: transparent;
    }

    .spinner {
        display: none;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: white;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to {
            transform: translate(-50%, -50%) rotate(360deg);
        }
    }

    .properties-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 2rem;
        padding: 2rem;
    }

    .property-card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.2s;
    }

    .property-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .property-image {
        height: 200px;
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
    }

    .property-details {
        padding: 1.5rem;
    }

    .property-details h3 {
        margin: 0 0 1rem;
        font-size: 1.25rem;
        color: #2d3748;
    }

    .features {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .feature {
        background: #e2e8f0;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
        color: #4a5568;
    }

    .price {
        margin: 1rem 0;
        font-size: 1.25rem;
        font-weight: 600;
        color: #2c5282;
    }

    .property-location {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        color: #718096;
        font-size: 0.875rem;
        margin-bottom: 1rem;
    }

    .view-button {
        width: 100%;
        background: #2c5282;
        color: white;
        border: none;
        padding: 0.75rem;
        border-radius: 0.375rem;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .view-button:hover {
        background: #2a4365;
    }

    .error-message {
        text-align: center;
        padding: 2rem;
        background: #fff5f5;
        border-radius: 8px;
        margin: 2rem;
    }

    .error-message h3 {
        color: #c53030;
        margin-bottom: 1rem;
    }

    .error-message p {
        color: #742a2a;
    }

    .debug-info {
        margin-top: 1rem;
        padding: 1rem;
        background: #f7fafc;
        border-radius: 4px;
        font-size: 0.875rem;
        text-align: left;
    }

    .debug-info pre {
        background: #edf2f7;
        padding: 0.5rem;
        border-radius: 4px;
        overflow-x: auto;
    }
    </style>

    <script>
        // Mobile menu toggle
        document.getElementById('mobileMenuBtn').addEventListener('click', function() {
            document.getElementById('navbarLinks').classList.toggle('show');
        });

        // Unit Type mapping as per assignment
        const unitTypes = {
            'Okapuka Safari Lodge': -2147483637,
            'The Weinberg': -2147483456
        };

        // Set min date to today and max date to 1 year from now
        const today = new Date();
        const maxDate = new Date();
        maxDate.setFullYear(today.getFullYear() + 1);

        const arrivalInput = document.getElementById('arrival');
        const departureInput = document.getElementById('departure');

        // Format dates for the input
        const formatDateForInput = (date) => {
            return date.toISOString().split('T')[0];
        };

        // Set min and max dates
        arrivalInput.min = formatDateForInput(today);
        arrivalInput.max = formatDateForInput(maxDate);
        departureInput.min = formatDateForInput(today);
        departureInput.max = formatDateForInput(maxDate);

        // Update departure min date when arrival is selected
        arrivalInput.addEventListener('change', (e) => {
            const selectedArrival = new Date(e.target.value);
            departureInput.min = formatDateForInput(selectedArrival);
            if (departureInput.value && new Date(departureInput.value) < selectedArrival) {
                departureInput.value = e.target.value;
            }
        });

        // Format date from YYYY-MM-DD to DD/MM/YYYY
        function formatDateForAPI(dateStr) {
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        // Add event listeners to buttons
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.search-button').forEach(button => {
                button.addEventListener('click', function(e) {
                    searchProperties(e, this.dataset.searchType);
                });
            });
        });

        async function searchProperties(event, searchType) {
            event.preventDefault();
            const form = document.getElementById('searchForm');
            const button = event.target.closest('.search-button');
            
            try {
                // Add loading state
                button.classList.add('loading');
                button.querySelector('.spinner').style.display = 'block';
                
                let response;
                if (searchType === 'available') {
                    // Get ages array from comma-separated string
                    const ages = form.ages.value.split(',')
                        .map(age => parseInt(age.trim()))
                        .filter(age => !isNaN(age));
                    
                    // Validate ages match occupants
                    if (ages.length !== parseInt(form.occupants.value)) {
                        throw new Error('Number of ages must match number of occupants');
                    }

                    // Check if property is selected for available search
                    if (!form.unit.value) {
                        throw new Error('Please select a property to check availability');
                    }

                    const apiData = {
                        "Property": form.unit.value,
                        "UnitTypeID": unitTypes[form.unit.value],
                        "Arrival": form.arrival.value.split('-').reverse().join('/'),
                        "Departure": form.departure.value.split('-').reverse().join('/'),
                        "Guests": ages.map(age => ({
                            "AgeGroup": age >= 12 ? "Adult" : "Child"
                        }))
                    };

                    response = await fetch('../backend/api.php', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(apiData)
                    });
                } else {
                    // For "Search All Properties", use GET request
                    console.log('Making GET request to search_all.php...');
                    response = await fetch('../backend/search_all.php', {
                        method: 'GET',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });
                }

                const responseText = await response.text();
                console.log('Raw API Response:', responseText);

                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    throw new Error(`Invalid JSON response: ${responseText.substring(0, 100)}...`);
                }

                // Log debug information if available
                if (data.debug) {
                    console.log('API Debug Info:', data.debug);
                }

                if (!data.success) {
                    const errorDetails = data.details || data.error || 'API request failed';
                    const debugInfo = data.debug_info ? JSON.stringify(data.debug_info, null, 2) : '';
                    const responseStructure = data.response_structure ? JSON.stringify(data.response_structure, null, 2) : '';
                    
                    throw new Error(`${errorDetails}\n\nDebug Info: ${debugInfo}\n\nResponse Structure: ${responseStructure}`);
                }

                // Display properties based on search type
                if (searchType === 'available') {
                    displayAvailableProperties([{
                        title: form.unit.value,
                        rate: data.data.Rate || data.data.rate || 'Price on request',
                        availability: data.data.Available || data.data.available ? 'Available' : 'Unavailable',
                        dateRange: {
                            arrival: form.arrival.value,
                            departure: form.departure.value
                        },
                        features: [
                            `${form.occupants.value} guests`,
                            ...ages.map(age => `${age} years old`),
                            `Unit Type ID: ${unitTypes[form.unit.value]}`
                        ],
                        image_url: form.unit.value === 'Okapuka Safari Lodge' 
                            ? './images/okapuka.jpg' 
                            : './images/weinberg.jpg'
                    }]);
                } else {
                    displayAllProperties(data.data);
                }
            } catch (error) {
                console.error('API Error:', error);
                document.getElementById('properties').innerHTML = `
                    <div class="error-message">
                        <h3>Oops! Something went wrong</h3>
                        <p>Error details: ${error.message}</p>
                        <div class="debug-info">
                            <h4>Debug Information:</h4>
                            <pre>${error.message}</pre>
                        </div>
                    </div>
                `;
            } finally {
                button.classList.remove('loading');
                button.querySelector('.spinner').style.display = 'none';
            }
        }

        function displayAvailableProperties(properties) {
            const propertiesDiv = document.getElementById('properties');
            propertiesDiv.innerHTML = properties.map(property => `
                <div class="property-card">
                    <div class="property-image" style="background-image: url('${property.image_url}')"></div>
                    <div class="property-details">
                        <h3>${property.title}</h3>
                        <div class="features">
                            ${property.features.map(feature => `<span class="feature">${feature}</span>`).join('')}
                        </div>
                        <div class="price">
                            <span class="amount">${property.rate ? 'N$' + property.rate : 'Price on request'}</span>
                        </div>
                        <div class="availability">
                            <span class="status ${property.availability === 'Available' ? 'available' : 'unavailable'}">
                                ${property.availability}
                            </span>
                        </div>
                        <div class="date-range">
                            <p>From: ${property.dateRange.arrival}</p>
                            <p>To: ${property.dateRange.departure}</p>
                        </div>
                        <button onclick="openBookingForm('${property.title}')" class="book-button" ${property.availability !== 'Available' ? 'disabled' : ''}>
                            Book Now
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function displayAllProperties(data) {
            const propertiesDiv = document.getElementById('properties');
            
            if (!data || !data.properties || data.properties.length === 0) {
                propertiesDiv.innerHTML = `
                    <div class="error-message">
                        <h3>No properties found</h3>
                        <p>Please try adjusting your search criteria.</p>
                    </div>
                `;
                return;
            }

            propertiesDiv.innerHTML = data.properties.map(property => `
                <div class="property-card">
                    <div class="property-image" style="background-image: url('${property.image_url || './images/placeholder.jpg'}')"></div>
                    <div class="property-details">
                        <h3>${property.title}</h3>
                        <div class="features">
                            ${property.features.filter(feature => feature).map(feature => 
                                `<span class="feature">${feature}</span>`
                            ).join('')}
                        </div>
                        <div class="price">
                            <span class="amount">${property.price}</span>
                        </div>
                        <div class="property-location">
                            <i class="fas fa-map-marker-alt"></i> ${property.location || 'Location not specified'}
                        </div>
                        ${property.booking_url ? 
                            `<a href="${property.booking_url}" class="view-button" target="_blank">
                                Book Now
                            </a>` :
                            `<button onclick="viewProperty('${property.locationId}')" class="view-button">
                                View Details
                            </button>`
                        }
                    </div>
                </div>
            `).join('');
        }

        function viewProperty(propertyId) {
            // Handle property detail view
            console.log('Viewing property:', propertyId);
            // You can implement a modal or redirect to a detail page
        }

        function openBookingForm(propertyTitle) {
            document.getElementById('selectedProperty').value = propertyTitle;
            document.getElementById('bookingForm').classList.remove('hidden');
        }

        function closeBookingForm() {
            document.getElementById('bookingForm').classList.add('hidden');
        }

        async function submitBooking(event) {
            event.preventDefault();
            const searchForm = document.getElementById('searchForm');
            const bookingData = {
                "Unit Name": document.getElementById('selectedProperty').value,
                "Arrival": formatDateForAPI(searchForm.arrival.value),
                "Departure": formatDateForAPI(searchForm.departure.value),
                "Occupants": parseInt(searchForm.occupants.value),
                "Ages": searchForm.ages.value.split(',').map(age => parseInt(age.trim()))
            };

            try {
                const response = await fetch('../backend/api.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(bookingData)
                });
                const data = await response.json();
                closeBookingForm();
                alert('Booking submitted successfully!');
            } catch (error) {
                alert('An error occurred while submitting the booking. Please try again.');
            }
        }
    </script>
</body>
</html> 